
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="description" content="Instructions for setting up Custom C++ sensors with esphomelib.">
<meta name="keywords" content="C++, Custom">
<meta itemprop="name" content="Custom Sensor Component">
<meta itemprop="description" content="Instructions for setting up Custom C++ sensors with esphomelib.">
<meta itemprop="image" content="https://esphomelib.com/_images/language-cpp.png">
<meta name="twitter:title" content="Custom Sensor Component">
<meta name="twitter:image:src" content="https://esphomelib.com/_images/language-cpp.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@OttoWinter_">
<meta name="twitter:description" content="Instructions for setting up Custom C++ sensors with esphomelib.">
<meta property="og:title" content="Custom Sensor Component"/>
<meta property="og:image" content="https://esphomelib.com/_images/language-cpp.png"/>
<meta property="og:type" content="website"/>
<meta property="og:site_name" content="esphomelib"/>
<meta property="og:description" content="Instructions for setting up Custom C++ sensors with esphomelib."/>
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#DFDFDF">

    <title>Custom Sensor Component &#8212; esphomelib 1.9.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/disqus.js"></script>
    <link rel="canonical" href="https://esphomelib.com/esphomeyaml/components/sensor/custom.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Dallas Temperature Sensor" href="dallas.html" />
    <link rel="prev" title="CSE7766 Power Sensor" href="cse7766.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
    <link rel="apple-touch-icon" href="../../../_static/apple-touch-icon.png" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo-full.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Custom Sensor Component</a><ul>
<li><a class="reference internal" href="#step-1-custom-sensor-definition">Step 1: Custom Sensor Definition</a></li>
<li><a class="reference internal" href="#step-2-registering-the-custom-sensor">Step 2: Registering the custom sensor</a></li>
<li><a class="reference internal" href="#step-3-bmp180-support">Step 3: BMP180 support</a></li>
<li><a class="reference internal" href="#bonus-sensors-with-multiple-output-values">Bonus: Sensors With Multiple Output Values</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="custom-sensor-component">
<h1>Custom Sensor Component<a class="headerlink" href="#custom-sensor-component" title="Permalink to this headline">Â¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">While I do try to keep the esphomeyaml configuration options as stable as possible
and back-port them, the esphomelib API is less stable. If something in the APIs needs
to be changed in order for something else to work, I will do so.</p>
</div>
<p>So, you just set up esphomelib for your ESP32/ESP8266, but sadly esphomelib is missing a sensor integration
youâ€™d really like to have ðŸ˜•. Itâ€™s pretty much impossible to support every single sensor, as there are simply too many.
Thatâ€™s why esphomelib has a really simple API for you to create your own <strong>custom sensors</strong> ðŸŽ‰</p>
<p>In this guide, we will go through creating a custom sensor component for the
<a class="reference external" href="https://www.adafruit.com/product/1603">BMP180</a> pressure sensor (we will only do the pressure part,
temperature is more or less the same). During this guide, you will learn how to 1. define a custom sensor
esphomelib can use 2. go over how to register the sensor so that it will be shown inside Home Assistant and
3. leverage an existing arduino library for the BMP180 with esphomelib.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since the creation of this guide, the BMP180 has been officially supported by the <a class="reference internal" href="bmp085.html"><span class="doc">BMP085 component</span></a>. The code still applies though.</p>
</div>
<p>This guide will require at least a bit of knowledge of C++, so be prepared for that. If youâ€™ve already written
code for an Arduino, you have already written C++ code :) (Arduino uses a slightly customized version of C++).
If you have any problems, Iâ€™m here to help: <a class="reference external" href="https://discord.gg/KhAMKrd">https://discord.gg/KhAMKrd</a></p>
<div class="section" id="step-1-custom-sensor-definition">
<h2>Step 1: Custom Sensor Definition<a class="headerlink" href="#step-1-custom-sensor-definition" title="Permalink to this headline">Â¶</a></h2>
<p>At this point, you might have a main source file like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">// ...</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">esphomelib</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ===== DO NOT EDIT ANYTHING BELOW THIS LINE =====</span>
  <span class="c1">// ========== AUTO GENERATED CODE BEGIN ===========</span>
  <span class="n">App</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&quot;livingroom&quot;</span><span class="p">);</span>
  <span class="n">App</span><span class="p">.</span><span class="n">init_log</span><span class="p">();</span>
  <span class="c1">// ...</span>
  <span class="c1">// =========== AUTO GENERATED CODE END ============</span>
  <span class="c1">// ========= YOU CAN EDIT AFTER THIS LINE =========</span>
  <span class="n">App</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">App</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To create your own custom sensor, you just have define a C++ class that extends <code class="docutils literal notranslate"><span class="pre">Component</span></code> and <code class="docutils literal notranslate"><span class="pre">Sensor</span></code> like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">using</span> <span class="k">namespace</span> <span class="n">esphomelib</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Component</span><span class="p">,</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">CustomSensor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span> <span class="o">:</span> <span class="n">Sensor</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// This will be called by App.setup()</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// This will be called by App.loop()</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
</pre></div>
</div>
<p>Additionally, you need to change an internal flag that changes how esphomeyaml compiles files.
The only downside is that this will make build times <em>a tiny bit</em> slower:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span class="l l-Scalar l-Scalar-Plain">esphomeyaml</span><span class="p p-Indicator">:</span>
  <span class="c1"># ...</span>
  <span class="l l-Scalar l-Scalar-Plain">use_custom_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
</div>
<p>Youâ€™ve just created your first esphomelib sensor ðŸŽ‰. It doesnâ€™t do very much right now and is never registered,
but itâ€™s a first step.</p>
<p>Letâ€™s now take a look at how a sensor works in esphomelib: A sensor is some hardware device (like a BMP180)
that sends out new values like temperatures.</p>
<p>Like any Component in esphomelib, if itâ€™s registered in the Application, <code class="docutils literal notranslate"><span class="pre">setup()</span></code> will be called for you when
<code class="docutils literal notranslate"><span class="pre">App.setup()</span></code> is run. <code class="docutils literal notranslate"><span class="pre">setup()</span></code> is also the place where you should do hardware initialization like setting
<code class="docutils literal notranslate"><span class="pre">pinMode()</span></code>. Next, every time <code class="docutils literal notranslate"><span class="pre">App.loop()</span></code> is called, your component will also receive a <code class="docutils literal notranslate"><span class="pre">loop()</span></code> call.
This is the place where you should do stuff like querying a sensor for a new value like you might be used
to do in an Arduino sketch.</p>
<p>Letâ€™s now also take a closer look at this line, which you might not be too used to when writing pure C code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CustomSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Component</span><span class="p">,</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span> <span class="p">{</span>
</pre></div>
</div>
<p>What this line is essentially saying is that weâ€™re defining our own class thatâ€™s called <code class="docutils literal notranslate"><span class="pre">CustomSensor</span></code>
which is also a subclass of <code class="docutils literal notranslate"><span class="pre">Component</span></code> and <code class="docutils literal notranslate"><span class="pre">Sensor</span></code> (in the namespace <code class="docutils literal notranslate"><span class="pre">sensor::</span></code>).
<code class="docutils literal notranslate"><span class="pre">Component</span></code> is there so that we can register it in our application and so that we will receive <code class="docutils literal notranslate"><span class="pre">setup()</span></code>
and <code class="docutils literal notranslate"><span class="pre">loop()</span></code> calls. Weâ€™re also inheriting from the <code class="docutils literal notranslate"><span class="pre">Sensor</span></code> class so that our custom sensor can send sensor
values to the frontend (like MQTT).</p>
<p>As most sensors really just setup some pins and then check the sensor every x seconds,
thereâ€™s another abstraction that weâ€™ll use to simplify our code: <code class="docutils literal notranslate"><span class="pre">PollingSensorComponent</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CustomSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">PollingSensorComponent</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">CustomSensor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">update_interval</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">sensor</span><span class="o">::</span><span class="n">PollingSensorComponent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">update_interval</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// This will be called by App.setup()</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">update</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// This will be called every `update_interval` milliseconds.</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>What <code class="docutils literal notranslate"><span class="pre">PollingSensorComponent</span></code> (and <code class="docutils literal notranslate"><span class="pre">PollingComponent</span></code>) does is essentially
just replace the <code class="docutils literal notranslate"><span class="pre">loop()</span></code> method and will call <code class="docutils literal notranslate"><span class="pre">update()</span></code> instead every <code class="docutils literal notranslate"><span class="pre">update_interval</span></code> milliseconds.
Because with most sensors, you really donâ€™t need to get the latest values with every single <code class="docutils literal notranslate"><span class="pre">loop()</span></code>
call (which can be called many times per second). If we forward the <code class="docutils literal notranslate"><span class="pre">update_interval</span></code> in our <em>constructor</em>
(line 3), <code class="docutils literal notranslate"><span class="pre">PollingSensorComponent</span></code> will call <code class="docutils literal notranslate"><span class="pre">update()</span></code> for us every <code class="docutils literal notranslate"><span class="pre">update_interval</span></code>
milliseconds, so that we donâ€™t have to do time checking ourselves.
You donâ€™t really need to know about C++ constructors for now, but I would definitely recommend reading up on them
in the Internet.</p>
<p>Letâ€™s also now make our sensor actually <em>output</em> values (42 for now):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">// class CustomSensor ...</span>
  <span class="c1">// ... previous code</span>
  <span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">publish_state</span><span class="p">(</span><span class="mf">42.0</span><span class="p">);</span>  <span class="c1">// 42Â°C</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">unit_of_measurement</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;Â°C&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">int8_t</span> <span class="n">accuracy_decimals</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// 2 decimal places of accuracy.</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Every time <code class="docutils literal notranslate"><span class="pre">update</span></code> is called we will now <strong>push</strong> a new value to the frontend.
The front-end will then relay those values to MQTT and finally to Home Assistant.
Additionally, we created a function that tells the sensor what unit of measurement the
value is in, this is not strictly required and only used for a nice output in Home Assistant.</p>
</div>
<div class="section" id="step-2-registering-the-custom-sensor">
<h2>Step 2: Registering the custom sensor<a class="headerlink" href="#step-2-registering-the-custom-sensor" title="Permalink to this headline">Â¶</a></h2>
<p>Now we have our Custom Sensor set up, but unfortunately it doesnâ€™t do much right now.
Actually â€¦ it does nothing because itâ€™s never registered in the App,
so esphomelib canâ€™t know about it. Letâ€™s change that.</p>
<p>In your global <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method, after youâ€™ve setup all other components, do the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre>
</pre></div>
</div>
<div class="code cpp highlight-yaml notranslate"><div class="highlight"><pre><span class="l l-Scalar l-Scalar-Plain">void setup() {</span>
  <span class="l l-Scalar l-Scalar-Plain">// ...</span>
  <span class="l l-Scalar l-Scalar-Plain">// =========== AUTO GENERATED CODE END ============</span>
  <span class="l l-Scalar l-Scalar-Plain">// ========= YOU CAN EDIT AFTER THIS LINE =========</span>

  <span class="l l-Scalar l-Scalar-Plain">auto *custom_sensor = new CustomSensor(&quot;My Custom Sensor&quot;, 5000); // update every 5000ms or every 5 seconds.</span>
  <span class="l l-Scalar l-Scalar-Plain">App.register_component(custom_sensor);</span>
  <span class="l l-Scalar l-Scalar-Plain">App.register_sensor(custom_sensor);</span>

  <span class="l l-Scalar l-Scalar-Plain">App.setup();</span>
<span class="l l-Scalar l-Scalar-Plain">}</span>
</pre></div>
</div>
<p>If you have Home Assistant MQTT discovery setup, it will even automatically show up in the frontend ðŸŽ‰
(with the entity id <code class="docutils literal notranslate"><span class="pre">sensor.custom_sensor_example</span></code>)</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../../_images/custom-ui.png"><img alt="../../../_images/custom-ui.png" src="../../../_images/custom-ui.png" style="width: 60%;" /></a>
</div>
<p>Letâ€™s go through the code for registering our custom sensor. First, weâ€™re creating a new CustomSensor
instance with the update interval of 5000ms using the <code class="docutils literal notranslate"><span class="pre">new</span></code> C++ syntax (important!) and assigning it to a
variable <code class="docutils literal notranslate"><span class="pre">custom_sensor</span></code> (using C++11 <code class="docutils literal notranslate"><span class="pre">auto</span></code> type specifier to make it simpler).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">auto</span> <span class="o">*</span><span class="n">custom_sensor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomSensor</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, we <em>register</em> the component in esphomelibâ€™s Application instance so that it can call the componentâ€™s
<code class="docutils literal notranslate"><span class="pre">setup()</span></code> and <code class="docutils literal notranslate"><span class="pre">loop()</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">App</span><span class="p">.</span><span class="n">register_component</span><span class="p">(</span><span class="n">custom_sensor</span><span class="p">);</span>

<span class="c1">// you could also write this, it&#39;s a bit shorter and works the same way.</span>
<span class="c1">// auto *custom_sensor = App.register_component(new CustomSensor(5000));</span>

<span class="n">App</span><span class="p">.</span><span class="n">register_sensor</span><span class="p">(</span><span class="n">custom_sensor</span><span class="p">);</span>
</pre></div>
</div>
<p>Lastly, weâ€™re registering the <em>sensor</em> with <code class="docutils literal notranslate"><span class="pre">register_sensor</span></code>, this will automatically set up a
bunch of callbacks so that it can publish state changes to MQTT when you call <code class="docutils literal notranslate"><span class="pre">publish_new_value()</span></code>,
create automatic MQTT discovery messages and setup a moving average over the sensor values
(adjust these as you would with any other sensor).</p>
</div>
<div class="section" id="step-3-bmp180-support">
<h2>Step 3: BMP180 support<a class="headerlink" href="#step-3-bmp180-support" title="Permalink to this headline">Â¶</a></h2>
<p>Letâ€™s finally make this custom sensor useful by adding the BMP180 aspect into it! A great feature of
esphomelib is that you can just use all existing arduino libraries, amazing right? Now for this example weâ€™ll
use the <a class="reference external" href="https://platformio.org/lib/show/525/Adafruit%20BMP085%20Library">Adafruit BMP085 Library</a>
library by Adafruit.</p>
<p>First weâ€™ll need to add the library to our platformio dependencies. To do so, put the following in
the <code class="docutils literal notranslate"><span class="pre">common</span></code> section of your <code class="docutils literal notranslate"><span class="pre">platformio.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span class="k">[common]</span>
<span class="na">lib_deps</span> <span class="o">=</span> <span class="s">Adafruit BMP085 Library</span>
<span class="na">build_flags</span> <span class="o">=</span>
<span class="na">upload_flags</span> <span class="o">=</span>
</pre></div>
</div>
<p>Next, include the library at the top of you main sketch file (<code class="docutils literal notranslate"><span class="pre">&lt;NODE_NAME&gt;/src/main.cpp</span></code>):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&quot;esphomelib/application.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Adafruit_BMP085.h&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">esphomelib</span><span class="p">;</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<p>Then update our sensor for BMP180 support:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">BMP180Sensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">PollingSensorComponent</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Adafruit_BMP085</span> <span class="n">bmp</span><span class="p">;</span>

  <span class="n">BMP180Sensor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">update_interval</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">sensor</span><span class="o">::</span><span class="n">PollingSensorComponent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">update_interval</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">bmp</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">update</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">pressure</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">.</span><span class="n">readPressure</span><span class="p">();</span> <span class="c1">// in Pa, or 1/100 hPa</span>
    <span class="n">publish_state</span><span class="p">(</span><span class="n">pressure</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">);</span> <span class="c1">// convert to hPa</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">unit_of_measurement</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;hPa&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">int8_t</span> <span class="n">accuracy_decimals</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// 2 decimal places of accuracy.</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="k">auto</span> <span class="o">*</span><span class="n">custom_sensor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BMP180Sensor</span><span class="p">(</span><span class="s">&quot;My BMP180 sensor&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
  <span class="n">App</span><span class="p">.</span><span class="n">register_component</span><span class="p">(</span><span class="n">custom_sensor</span><span class="p">);</span>
  <span class="n">App</span><span class="p">.</span><span class="n">register_sensor</span><span class="p">(</span><span class="n">custom_sensor</span><span class="p">);</span>

  <span class="n">App</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<p>Thereâ€™s not too much going on there. First, we define the variable <code class="docutils literal notranslate"><span class="pre">bmp</span></code> of type <code class="docutils literal notranslate"><span class="pre">Adafruit_BMP085</span></code>
inside our class as a class member. In <code class="docutils literal notranslate"><span class="pre">setup()</span></code> we initialize the library and in <code class="docutils literal notranslate"><span class="pre">update()</span></code> we read the
pressure and send it out to MQTT.</p>
<p>Youâ€™ve now successfully created your first custom sensor component ðŸŽ‰ Happy coding!</p>
</div>
<div class="section" id="bonus-sensors-with-multiple-output-values">
<h2>Bonus: Sensors With Multiple Output Values<a class="headerlink" href="#bonus-sensors-with-multiple-output-values" title="Permalink to this headline">Â¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">PollingSensorComponent</span></code> doesnâ€™t fit every use-case. Sometimes, (as with the BMP180),
a sensor can expose multiple values (temperature <em>and</em> pressure, for example).</p>
<p>Doing so in esphomelib is a bit more difficult. Basically, we will have to change our sensor
model to have <em>one component</em> that reads out the values and <em>one sensor class</em> for each value
we want to expose.</p>
<p>Letâ€™s look at what that could look like in code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">// An empty sensor subclass that will &quot;proxy&quot; the temperature values</span>
<span class="k">class</span> <span class="nc">BMP280TemperatureSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">BMP280TemperatureSensor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span> <span class="o">:</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">unit_of_measurement</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;Â°C&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">int8_t</span> <span class="n">accuracy_decimals</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// An empty sensor subclass that will &quot;proxy&quot; the pressure values</span>
<span class="k">class</span> <span class="nc">BMP280PressureSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">BMP280PressureSensor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span> <span class="o">:</span> <span class="n">sensor</span><span class="o">::</span><span class="n">Sensor</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">unit_of_measurement</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;hPa&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">int8_t</span> <span class="n">accuracy_decimals</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">BMP180Component</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PollingComponent</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Adafruit_BMP085</span> <span class="n">bmp</span><span class="p">;</span>
  <span class="n">BMP280TemperatureSensor</span> <span class="o">*</span><span class="n">temperature_sensor</span><span class="p">;</span>
  <span class="n">BMP280PressureSensor</span> <span class="o">*</span><span class="n">pressure_sensor</span><span class="p">;</span>

  <span class="n">BMP180Component</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">temperature_name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">pressure_name</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">update_interval</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">PollingComponent</span><span class="p">(</span><span class="n">update_interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">temperature_sensor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BMP280TemperatureSensor</span><span class="p">(</span><span class="n">temperature_name</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">pressure_sensor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BMP280PressureSensor</span><span class="p">(</span><span class="n">pressure_name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">bmp</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">update</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// This is the actual sensor reading logic.</span>
    <span class="kt">int</span> <span class="n">pressure</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">.</span><span class="n">readPressure</span><span class="p">();</span>
    <span class="n">pressure_sensor</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">pressure</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">temperature</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">.</span><span class="n">readTemperature</span><span class="p">();</span>
    <span class="n">temperature_sensor</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">temperature</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="k">auto</span> <span class="o">*</span><span class="n">custom_bmp180</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BMP180Component</span><span class="p">(</span><span class="s">&quot;BMP180 Temperature&quot;</span><span class="p">,</span> <span class="s">&quot;BMP180 Pressure&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
  <span class="c1">// The BMP180Component is a *component*, so it needs to be registered.</span>
  <span class="n">App</span><span class="p">.</span><span class="n">register_component</span><span class="p">(</span><span class="n">custom_bmp180</span><span class="p">);</span>

  <span class="c1">// But the temperature&amp;pressure classes are *sensors*, so each of them needs to be registered</span>
  <span class="n">App</span><span class="p">.</span><span class="n">register_sensor</span><span class="p">(</span><span class="n">custom_bmp180</span><span class="o">-&gt;</span><span class="n">temperature_sensor</span><span class="p">);</span>
  <span class="n">App</span><span class="p">.</span><span class="n">register_sensor</span><span class="p">(</span><span class="n">custom_bmp180</span><span class="o">-&gt;</span><span class="n">pressure_sensor</span><span class="p">);</span>

  <span class="n">App</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Thatâ€™s a lot of code :P Basically, what it boils down to is you have one central component <code class="docutils literal notranslate"><span class="pre">BMP180Component</span></code>
which handles the communication with the BMP180 and a <code class="docutils literal notranslate"><span class="pre">Sensor</span></code> subclass for each value you want to expose.</p>
<p>Most of the magic happens inside the <code class="docutils literal notranslate"><span class="pre">update()</span></code> function. Here, the values are read from the BMP180 and are
sent to esphomelib via the pressure/temperature sensor proxies we set up in the constructor.</p>
<p>The only other thing you need to change is the registering inside <code class="docutils literal notranslate"><span class="pre">setup()</span></code>.
Because <code class="docutils literal notranslate"><span class="pre">BMP180Component</span></code> is a <em>component</em> (because it has a lifecycle through the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> and <code class="docutils literal notranslate"><span class="pre">loop()</span></code> methods),
it needs to be registered with <code class="docutils literal notranslate"><span class="pre">App.register_component(...)</span></code>. However, as itâ€™s now not a subclass
of <code class="docutils literal notranslate"><span class="pre">Sensor</span></code> anymore, it cannot be registered as a sensor.</p>
<p>But because the <code class="docutils literal notranslate"><span class="pre">BMP280TemperatureSensor</span></code> and <code class="docutils literal notranslate"><span class="pre">BMP280PressureSensor</span></code> <em>are</em> subclasses of sensors,
they do need to be registered so that esphomelib can do all the magic stuff like setting up MQTT discovery
for them. Thatâ€™s why we call <code class="docutils literal notranslate"><span class="pre">App.register_sensor</span></code> for each sensor we created in the end.</p>
</div>
<div class="section" id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/OttoWinter/esphomelib/blob/master/examples/custom-bmp180-sensor/custom-bmp180-sensor.cpp">Full source code</a></li>
<li><a class="reference external" href="https://github.com/OttoWinter/esphomedocs/blob/current/esphomeyaml/components/sensor/custom.rst">Edit this page on GitHub</a></li>
</ul>
<div data-disqus-identifier="esphomeyaml-components-sensor-custom" id="disqus_thread"></div></div>
</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      
      
      
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>